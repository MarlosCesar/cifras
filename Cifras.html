<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Seletor de Cifras</title>
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary-color:#3b82f6;--primary-dark:#2563eb;--primary-hover:#e0e7ff;--danger-color:#ef4444;--danger-dark:#dc2626;--gray-light:#f3f4f6;--gray-medium:#e5e7eb;--text-color-dark:#333;--text-color-light:#4b5563;--shadow-base:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);--shadow-primary:0 0 10px rgba(37,99,235,0.3);--header-bg:#1A202C;--header-text:#E2E8F0;--header-hover:#2D3748}
    html,body{overflow-x:hidden;overflow-y:auto;background-color:var(--gray-light);font-family:'Inter',sans-serif;color:var(--text-color-dark)}
    .header-professional{background-color:var(--header-bg);color:var(--header-text);box-shadow:var(--shadow-base)}
    .header-professional button{transition:background-color 0.3s ease,transform 0.1s ease;display:flex;align-items:center;justify-content:center}
    .header-professional button:hover{background-color:var(--header-hover)}
    .header-professional button:active{transform:scale(0.98)}
    .tabs{display:flex;gap:0.5rem;border-bottom:2px solid var(--gray-medium);margin-bottom:1rem;flex-wrap:wrap;padding:0 1rem}
    .tab{padding:0.65rem 1.2rem;cursor:pointer;border-radius:0.5rem 0.5rem 0 0;background-color:#f9fafb;border:1px solid transparent;border-bottom:2px solid transparent;transition:all 0.2s ease;outline-offset:2px;color:var(--text-color-light);font-weight:500}
    [role="tab"]{user-select:none}
    .tab:hover,.tab:focus-visible{background-color:var(--primary-hover);border-color:var(--primary-color) transparent transparent;outline:none;color:var(--primary-dark)}
    .tab.active{background-color:white;border-color:var(--primary-color) var(--primary-color) white;font-weight:600;color:var(--primary-dark);box-shadow:0 -2px 5px rgba(0,0,0,0.05)}
    .image-container{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--gray-medium);border-radius:0.75rem;overflow:hidden;cursor:pointer;transition:all 0.2s ease;background-color:white;box-shadow:0 1px 3px rgba(0,0,0,0.05);position:relative}
    .image-container:focus-visible{outline:2px solid var(--primary-color);outline-offset:3px}
    .image-container.selected{border-color:var(--primary-dark);box-shadow:var(--shadow-primary);background-color:var(--primary-hover)}
    .image-container .image-checkbox{position:absolute;top:8px;left:8px;z-index:10;opacity:0;pointer-events:none;transition:opacity 0.2s ease}
    .show-checkboxes .image-container .image-checkbox{opacity:1;pointer-events:all}
    .show-checkboxes #select-all-container{display:flex!important}
    .drag-over{border:2px dashed var(--primary-dark)!important;background-color:rgba(59,130,246,0.1)!important}
    .image-container.dragging{opacity:0.4;transform:scale(0.98)}
    .image-container img{width:2.2cm;height:3.3cm;object-fit:cover;border-radius:0.35rem;flex-shrink:0;box-shadow:0 1px 4px rgba(0,0,0,0.1);cursor:zoom-in}
    .image-name{font-size:0.95rem;color:var(--text-color-dark);flex-grow:1;overflow-wrap:break-word;word-break:break-word;max-width:calc(100% - 2.2cm - 12px);line-height:1.4;cursor:zoom-in}
    .fullscreen-image{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.95);display:flex;justify-content:center;align-items:center;cursor:zoom-out;z-index:9999;touch-action:none;margin:0;padding:0;overflow:hidden}
    .fullscreen-image img{max-width:100%;max-height:100%;object-fit:contain;transition:transform 0.25s ease;transform-origin:center center;margin:0;padding:0}
    .fullscreen-controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:15px;background:rgba(0,0,0,0.7);padding:12px 20px;border-radius:8px;z-index:10000}
    .zoom-btn{background:rgba(255,255,255,0.2);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color 0.3s ease,transform 0.1s ease}
    .zoom-btn:hover{background:rgba(255,255,255,0.3)}
    .zoom-btn:active{transform:scale(0.95)}
    .loading-spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(0,0,0,0.6);padding:20px;border-radius:12px;z-index:10000;color:white}
    .loading-spinner.active{display:flex;align-items:center;justify-content:center}
    #status-message{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,0.7);color:white;padding:10px 20px;border-radius:5px;z-index:1000;opacity:0;transition:opacity 0.3s ease-in-out;pointer-events:none;text-align:center}
    #status-message.show{opacity:1}
    @media (max-width:640px){.header-professional h1{font-size:1.5rem}.header-professional .space-x-4{gap:0.5rem}.header-professional button{padding:0.6rem}.tabs{flex-wrap:wrap;justify-content:center;gap:0.35rem;padding:0 0.5rem}.tab{padding:0.5rem 0.8rem;font-size:0.9rem}.main-content-area{padding:0.75rem}.image-container{flex-direction:row;align-items:center;gap:10px;padding:10px}.image-container img{width:1.8cm;height:2.7cm}.image-name{font-size:0.875rem;max-width:calc(100% - 1.8cm - 10px)}.flex-wrap.gap-2{flex-direction:column;width:100%}.flex-wrap.gap-2 button{width:100%;justify-content:center}.flex-wrap.gap-2 button i{margin-right:0.5rem}.fullscreen-controls{flex-direction:row;gap:10px;padding:10px 15px}.zoom-btn{width:45px;height:45px;font-size:22px}.fullscreen-image img{width:auto;height:auto;max-width:100vw;max-height:100vh}}
    @media (min-width:641px) and (max-width:1024px){.tabs{justify-content:flex-start;padding:0 1.5rem}.tab{padding:0.6rem 1.1rem;font-size:0.95rem}.image-container{padding:10px;gap:10px}.image-container img{width:2cm;height:3cm}.image-name{font-size:0.9rem;max-width:calc(100% - 2cm - 10px)}}
  </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
  <header class="header-professional p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-semibold tracking-wide">Seletor de Cifras</h1>
      <div class="flex items-center space-x-4">
        <button id="sync-btn" class="p-2 rounded-full" aria-label="Sincronizar" title="Sincronizar"><i class="fas fa-sync-alt text-lg" aria-hidden="true"></i></button>
        <button id="settings-btn" class="p-2 rounded-full" aria-label="Configurações" title="Configurações"><i class="fas fa-cog text-lg" aria-hidden="true"></i></button>
      </div>
    </div>
  </header>

  <main class="container mx-auto p-4 flex flex-col gap-4 main-content-area" role="main">
    <section class="w-full bg-white rounded-xl shadow-md overflow-hidden flex flex-col" aria-label="Seletor de músicas e imagens">
      <div class="p-4 bg-gray-50 border-b flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <h2 class="font-semibold text-xl text-gray-700">Minhas Cifras</h2>
        <div class="flex flex-wrap gap-2 justify-end">
          <button id="open-cloud-folder" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center" aria-label="Buscar cifras na nuvem (OneDrive)" title="Buscar cifras na nuvem (OneDrive)"><i class="fas fa-cloud mr-2" aria-hidden="true"></i> Buscar em Nuvem</button>
          <button id="open-file-dialog" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" aria-label="Buscar cifras localmente" title="Buscar cifras localmente"><i class="fas fa-folder-open mr-2" aria-hidden="true"></i> Buscar Local</button>
          <input type="file" id="file-input" class="hidden" accept="image/*" multiple aria-hidden="true" tabindex="-1"/>
        </div>
      </div>

      <nav class="tabs" id="tabs-container" role="tablist" aria-label="Abas das categorias de cifras"></nav>

      <div class="p-4 flex flex-col gap-4 flex-1">
        <div id="select-all-container" class="flex flex-wrap items-center gap-4 mb-2 hidden">
          <label class="inline-flex items-center gap-2 cursor-pointer text-gray-700 font-medium" for="select-all"><input type="checkbox" id="select-all" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" aria-label="Selecionar todas as imagens"/><span>Selecionar todas</span></label>
          <button id="clear-selection-btn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center" disabled aria-disabled="true" aria-label="Limpar seleção"><i class="fas fa-undo mr-2" aria-hidden="true"></i> Limpar seleção</button>
          <button id="delete-selected-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center" disabled aria-disabled="true" aria-label="Excluir imagens selecionadas"><i class="fas fa-trash-alt mr-2" aria-hidden="true"></i> Excluir selecionadas</button>
        </div>

        <div id="image-list" class="flex flex-col gap-4" aria-live="polite" aria-atomic="true"><p class="text-center text-gray-500 py-8">Nenhuma imagem encontrada nesta categoria.</p></div>
      </div>
    </section>
  </main>

  <div id="loading-spinner" class="loading-spinner"><i class="fas fa-spinner fa-spin fa-3x text-blue-600" aria-hidden="true"></i><span class="sr-only">Carregando...</span></div>
  <div id="status-message" aria-live="polite"></div>

  <script>
    const DOM={tabsContainer:document.getElementById('tabs-container'),imageList:document.getElementById('image-list'),fileInput:document.getElementById('file-input'),openFileDialogButton:document.getElementById('open-file-dialog'),openCloudFolderButton:document.getElementById('open-cloud-folder'),selectAllContainer:document.getElementById('select-all-container'),selectAllCheckbox:document.getElementById('select-all'),deleteSelectedBtn:document.getElementById('delete-selected-btn'),clearSelectionBtn:document.getElementById('clear-selection-btn'),syncBtn:document.getElementById('sync-btn'),settingsBtn:document.getElementById('settings-btn'),loadingSpinner:document.getElementById('loading-spinner'),statusMessage:document.getElementById('status-message'),body:document.body},tabs=["Domingo Manhã","Domingo Noite","Segunda","Quarta","Culto Jovem","Santa Ceia","Outros"],ONE_DRIVE_FOLDER_URL="https://1drv.ms/f/c/a71268bf66931c02/EpYyUsypAQhGgpWC9YuvE54BD_o9NX9tRar0piSzq4V4Xg";
    let imageGalleryByTab=new Map(),selectedImagesByTab=new Map(),currentTab=tabs[0],dragStartIndex=null,longPressTimer,isLongPress=false;
    tabs.forEach(tab=>(imageGalleryByTab.set(tab,[]),selectedImagesByTab.set(tab,new Set())));
    const Utils={removeFileExtension:filename=>filename.replace(/\.[^/.]+$/,""),showStatus:message=>(DOM.statusMessage.textContent=message,DOM.statusMessage.classList.add('show'),setTimeout(()=>DOM.statusMessage.classList.remove('show'),3000)),debounce:(func,timeout=100)=>{let timer;return(...args)=>(clearTimeout(timer),timer=setTimeout(()=>func.apply(this,args),timeout))},objectURLCache:new Map(),revokeObjectURL:url=>(Utils.objectURLCache.has(url)&&(URL.revokeObjectURL(url),Utils.objectURLCache.delete(url))),createObjectURL:blob=>(url=URL.createObjectURL(blob),Utils.objectURLCache.set(url,true),url)};
    const IndexedDBManager={db:null,open:()=>new Promise((resolve,reject)=>{if(IndexedDBManager.db)return resolve(IndexedDBManager.db);const request=indexedDB.open('ImageSelectorDB',2);request.onupgradeneeded=event=>{const db=event.target.result;!db.objectStoreNames.contains('images')&&db.createObjectStore('images',{keyPath:'name'});!db.objectStoreNames.contains('metadata')&&db.createObjectStore('metadata',{keyPath:'id'})};request.onsuccess=event=>(IndexedDBManager.db=event.target.result,resolve(IndexedDBManager.db));request.onerror=event=>(console.error('IndexedDB error:',event.target.errorCode),reject(event.target.errorCode))}),addImageBlob:(imageName,blob)=>new Promise(async(resolve,reject)=>{try{const db=await IndexedDBManager.open(),transaction=db.transaction(['images'],'readwrite'),store=transaction.objectStore('images'),request=store.put({name:imageName,blob:blob});request.onsuccess=()=>resolve();request.onerror=event=>reject(event.target.error)}catch(e){reject(e)}}),getImageBlob:imageName=>new Promise(async(resolve,reject)=>{try{const db=await IndexedDBManager.open(),transaction=db.transaction(['images'],'readonly'),store=transaction.objectStore('images'),request=store.get(imageName);request.onsuccess=event=>resolve(event.target.result?event.target.result.blob:null);request.onerror=event=>reject(event.target.error)}catch(e){reject(e)}}),deleteImageBlob:imageName=>new Promise(async(resolve,reject)=>{try{const db=await IndexedDBManager.open(),transaction=db.transaction(['images'],'readwrite'),store=transaction.objectStore('images'),request=store.delete(imageName);request.onsuccess=()=>resolve();request.onerror=event=>reject(event.target.error)}catch(e){reject(e)}}),getAllImageNames:()=>new Promise(async(resolve,reject)=>{try{const db=await IndexedDBManager.open(),transaction=db.transaction(['images'],'readonly'),store=db.transaction('images','readonly').objectStore('images'),request=store.getAllKeys();request.onsuccess=event=>resolve(event.target.result);request.onerror=event=>reject(event.target.error)}catch(e){reject(e)}}),saveMetadata:state=>new Promise(async(resolve,reject)=>{try{const db=await IndexedDBManager.open(),transaction=db.transaction(['metadata'],'readwrite'),store=transaction.objectStore('metadata'),request=store.put({id:'appState',state:state});request.onsuccess=()=>resolve();request.onerror=event=>reject(event.target.error)}catch(e){reject(e)}}),loadMetadata:()=>new Promise(async(resolve,reject)=>{try{const db=await IndexedDBManager.open(),transaction=db.transaction(['metadata'],'readonly'),store=transaction.objectStore('metadata'),request=store.get('appState');request.onsuccess=event=>resolve(event.target.result?event.target.result.state:null);request.onerror=event=>reject(event.target.error)}catch(e){reject(e)}})};
    const ImageProcessor={processImageFile:file=>new Promise((resolve,reject)=>{const img=new Image(),url=Utils.createObjectURL(file);img.onload=()=>{const canvas=document.createElement('canvas'),MAX_SIZE=800;let width=img.width,height=img.height;width>height?width>MAX_SIZE&&(height*=MAX_SIZE/width,width=MAX_SIZE):height>MAX_SIZE&&(width*=MAX_SIZE/height,height=MAX_SIZE);canvas.width=width;canvas.height=height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,width,height);canvas.toBlob(blob=>(Utils.revokeObjectURL(url),blob?resolve({name:file.name,blob:blob}):reject(new Error('Falha ao criar Blob da imagem.')))},'image/webp',0.75);img.onerror=()=>(Utils.revokeObjectURL(url),reject(new Error('Erro ao carregar a imagem para processamento.'));img.src=url})};
    const StateManager={saveState:Utils.debounce(async()=>{const state={images:Object.fromEntries(Array.from(imageGalleryByTab.entries()).map(([tab,names])=>[tab,Array.from(names)]),selected:Object.fromEntries(Array.from(selectedImagesByTab.entries()).map(([tab,set])=>[tab,Array.from(set)]),currentTab};try{await IndexedDBManager.saveMetadata(state)}catch(e){console.error('Erro ao salvar estado no IndexedDB:',e);Utils.showStatus('Erro ao salvar dados.')}},500),loadState:async()=>{try{const state=await IndexedDBManager.loadMetadata();if(state){imageGalleryByTab=new Map(Object.entries(state.images||{}));selectedImagesByTab=new Map();for(const tab of tabs)selectedImagesByTab.set(tab,new Set(state.selected?.[tab]||[]));currentTab=state.currentTab||tabs[0]}else StateManager.initEmptyState()}catch(e){console.error('Erro ao carregar estado do IndexedDB:',e);StateManager.initEmptyState()}},initEmptyState:()=>(imageGalleryByTab=new Map(),selectedImagesByTab=new Map(),tabs.forEach(tab=>(imageGalleryByTab.set(tab,[]),selectedImagesByTab.set(tab,new Set())))};
    const UI={showLoading:()=>DOM.loadingSpinner.classList.add('active'),hideLoading:()=>DOM.loadingSpinner.classList.remove('active'),createTabs:()=>{DOM.tabsContainer.innerHTML='';const fragment=document.createDocumentFragment();tabs.forEach((tab,index)=>{const tabBtn=document.createElement('button');tabBtn.className='tab';tabBtn.setAttribute('role','tab');tabBtn.setAttribute('tabindex',index===0?'0':'-1');tabBtn.setAttribute('aria-selected',index===0?'true':'false');tabBtn.id=`tab-${tab.replace(/\s+/g,'-').toLowerCase()}`;tabBtn.textContent=tab;tabBtn.addEventListener('click',()=>TabManager.switchTab(tab));tabBtn.addEventListener('keydown',e=>{const currentActiveIndex=tabs.indexOf(currentTab);let nextIndex=currentActiveIndex;if(e.key==='ArrowRight')nextIndex=(currentActiveIndex+1)%tabs.length;else if(e.key==='ArrowLeft')nextIndex=(currentActiveIndex-1+tabs.length)%tabs.length;else if(e.key==='Home')nextIndex=0;else if(e.key==='End')nextIndex=tabs.length-1;if(nextIndex!==currentActiveIndex){e.preventDefault();TabManager.switchTab(tabs[nextIndex]);DOM.tabsContainer.querySelector(`#tab-${tabs[nextIndex].replace(/\s+/g,'-').toLowerCase()}`).focus()}else if(e.key==='Enter'||e.key===' '){e.preventDefault();TabManager.switchTab(tab)}});fragment.appendChild(tabBtn)});DOM.tabsContainer.appendChild(fragment)},updateTabsUI:()=>{const buttons=DOM.tabsContainer.querySelectorAll('.tab');buttons.forEach(btn=>{const isActive=btn.textContent===currentTab;btn.classList.toggle('active',isActive);btn.setAttribute('aria-selected',isActive);btn.setAttribute('tabindex',isActive?'0':'-1')})},renderImages:async()=>{DOM.imageList.querySelectorAll('img[data-object-url]').forEach(img=>Utils.revokeObjectURL(img.dataset.objectUrl));const imageNames=imageGalleryByTab.get(currentTab)||[],fragment=document.createDocumentFragment();if(imageNames.length===0){const p=document.createElement('p');p.className='text-center text-gray-500 py-8';p.textContent='Nenhuma imagem encontrada nesta categoria.';fragment.appendChild(p)}else{DOM.selectAllCheckbox.disabled=false;const imagesToRender=[];for(const imageName of imageNames){const blob=await IndexedDBManager.getImageBlob(imageName);blob?imagesToRender.push({name:imageName,blob:blob}):(console.warn(`Imagem "${imageName}" não encontrada no IndexedDB. Removendo da lista.`),imageGalleryByTab.set(currentTab,imageNames.filter(name=>name!==imageName)),selectedImagesByTab.get(currentTab).delete(imageName))}imagesToRender.forEach(({name,blob})=>{const container=UI.createImageElement(name,blob);fragment.appendChild(container)})}DOM.imageList.innerHTML='';DOM.imageList.appendChild(fragment);UI.updateSelectAllCheckbox();UI.updateButtonsState();UI.updateCheckboxesVisibility()},createImageElement:(imageName,imageBlob)=>{const container=document.createElement('div');container.className='image-container';container.setAttribute('draggable','true');container.setAttribute('tabindex','0');container.dataset.name=imageName;const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.className='form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 image-checkbox';checkbox.setAttribute('aria-label',`Selecionar ${Utils.removeFileExtension(imageName)}`);checkbox.checked=selectedImagesByTab.get(currentTab).has(imageName);checkbox.addEventListener('change',e=>(e.stopPropagation(),ImageManager.toggleSelectImage(imageName,checkbox.checked,container)));checkbox.checked?container.classList.add('selected'):container.classList.remove('selected');const img=document.createElement('img'),objectURL=Utils.createObjectURL(imageBlob);img.src=objectURL;img.dataset.objectUrl=objectURL;img.alt=Utils.removeFileExtension(imageName);img.title="Clique para ampliar";const nameSpan=document.createElement('span');nameSpan.className='image-name';nameSpan.textContent=Utils.removeFileExtension(imageName);nameSpan.title="Clique para ampliar";const deleteBtn=document.createElement('button');deleteBtn.className='ml-auto p-1 text-red-500 hover:text-red-700 rounded-full transition-colors hidden sm:block';deleteBtn.innerHTML='<i class="fas fa-times" aria-hidden="true"></i>';deleteBtn.setAttribute('aria-label',`Excluir cifra ${Utils.removeFileExtension(imageName)}`);deleteBtn.title=`Excluir ${Utils.removeFileExtension(imageName)}`;deleteBtn.addEventListener('click',e=>(e.stopPropagation(),ImageManager.deleteImage(imageName)));container.appendChild(checkbox);container.appendChild(img);container.appendChild(nameSpan);container.appendChild(deleteBtn);return container},updateSelectAllCheckbox:()=>{const images=imageGalleryByTab.get(currentTab)||[];if(images.length===0){DOM.selectAllCheckbox.checked=false;DOM.selectAllCheckbox.indeterminate=false;DOM.selectAllCheckbox.disabled=true;return}DOM.selectAllCheckbox.disabled=false;const selectedCount=selectedImagesByTab.get(currentTab).size;DOM.selectAllCheckbox.checked=selectedCount===images.length;DOM.selectAllCheckbox.indeterminate=selectedCount>0&&selectedCount<images.length},updateButtonsState:()=>{const anySelected=selectedImagesByTab.get(currentTab).size>0;DOM.deleteSelectedBtn.disabled=!anySelected;DOM.clearSelectionBtn.disabled=!anySelected;DOM.deleteSelectedBtn.setAttribute('aria-disabled',!anySelected);DOM.clearSelectionBtn.setAttribute('aria-disabled',!anySelected)},updateCheckboxesVisibility:()=>{const anySelected=selectedImagesByTab.get(currentTab).size>0;anySelected?DOM.body.classList.add('show-checkboxes'):DOM.body.classList.remove('show-checkboxes')},openFullscreen:(src,alt)=>{const overlay=document.createElement('div');overlay.className='fullscreen-image';overlay.setAttribute('role','dialog');overlay.setAttribute('aria-modal','true');overlay.setAttribute('aria-label',`Visualização da imagem ${alt}`);const img=document.createElement('img');img.src=src;img.alt=alt;img.tabIndex=0;img.style.transform='scale(1)';const controls=document.createElement('div');controls.className='fullscreen-controls';const zoomInBtn=document.createElement('button');zoomInBtn.className='zoom-btn';zoomInBtn.innerHTML='<i class="fas fa-search-plus"></i>';zoomInBtn.setAttribute('aria-label','Zoom in');const zoomOutBtn=document.createElement('button');zoomOutBtn.className='zoom-btn';zoomOutBtn.innerHTML='<i class="fas fa-search-minus"></i>';zoomOutBtn.setAttribute('aria-label','Zoom out');const resetZoomBtn=document.createElement('button');resetZoomBtn.className='zoom-btn';resetZoomBtn.innerHTML='<i class="fas fa-expand"></i>';resetZoomBtn.setAttribute('aria-label','Reset zoom');let scale=1,translateX=0,translateY=0,isDragging=false,startPoint={x:0,y:0};const updateTransform=()=>img.style.transform=`scale(${scale}) translate(${translateX}px, ${translateY}px)`;zoomInBtn.addEventListener('click',e=>(e.stopPropagation(),scale=Math.min(scale*1.2,5),updateTransform()));zoomOutBtn.addEventListener('click',e=>(e.stopPropagation(),scale=Math.max(scale/1.2,1),scale===1&&(translateX=0,translateY=0),updateTransform()));resetZoomBtn.addEventListener('click',e=>(e.stopPropagation(),scale=1,translateX=0,translateY=0,updateTransform()));img.addEventListener('wheel',e=>(e.preventDefault(),delta=-e.deltaY,oldScale=scale,delta>0?scale=Math.min(scale*1.1,5):scale=Math.max(scale/1.1,1),rect=img.getBoundingClientRect(),mouseX=e.clientX-rect.left,mouseY=e.clientY-rect.top,translateX=translateX+mouseX*(1/oldScale-1/scale),translateY=translateY+mouseY*(1/oldScale-1/scale),scale===1&&(translateX=0,translateY=0),updateTransform()),{passive:false});img.addEventListener('mousedown',e=>{if(scale>1){isDragging=true;startPoint={x:e.clientX-translateX,y:e.clientY-translateY};img.style.cursor='grabbing';overlay.style.cursor='grabbing'}});document.addEventListener('mousemove',e=>{if(!isDragging)return;translateX=e.clientX-startPoint.x;translateY=e.clientY-startPoint.y;updateTransform()});document.addEventListener('mouseup',()=>(isDragging=false,img.style.cursor='zoom-out',overlay.style.cursor='zoom-out'));let initialPinchDistance=null,lastScale=1;img.addEventListener('touchstart',e=>{if(e.touches.length===1){isDragging=true;startPoint={x:e.touches[0].clientX-translateX,y:e.touches[0].clientY-translateY}}else if(e.touches.length===2){initialPinchDistance=Math.hypot(e.touches[1].pageX-e.touches[0].pageX,e.touches[1].pageY-e.touches[0].pageY);lastScale=scale}e.preventDefault()},{passive:false});img.addEventListener('touchmove',e=>{if(e.touches.length===1&&isDragging){translateX=e.touches[0].clientX-startPoint.x;translateY=e.touches[0].clientY-startPoint.y;updateTransform()}else if(e.touches.length===2&&initialPinchDistance){const currentPinchDistance=Math.hypot(e.touches[1].pageX-e.touches[0].pageX,e.touches[1].pageY-e.touches[0].pageY);scale=lastScale*(currentPinchDistance/initialPinchDistance);scale=Math.max(1,Math.min(scale,5));const centerX=(e.touches[0].clientX+e.touches[1].clientX)/2,centerY=(e.touches[0].clientY+e.touches[1].clientY)/2,rect=img.getBoundingClientRect(),relativeX=centerX-rect.left,relativeY=centerY-rect.top;translateX=translateX+relativeX*(1/lastScale-1/scale);translateY=translateY+relativeY*(1/lastScale-1/scale);scale===1&&(translateX=0,translateY=0);updateTransform()}e.preventDefault()},{passive:false});img.addEventListener('touchend',()=>(isDragging=false,initialPinchDistance=null));controls.appendChild(zoomInBtn);controls.appendChild(zoomOutBtn);controls.appendChild(resetZoomBtn);overlay.appendChild(img);overlay.appendChild(controls);document.body.appendChild(overlay);img.focus();const closeFullscreen=()=>(document.body.removeChild(overlay),overlay.removeEventListener('click',closeFullscreen),document.removeEventListener('keydown',handleKeyDown),Utils.revokeObjectURL(img.src)),handleKeyDown=e=>{if(e.key==='Escape')closeFullscreen()};overlay.addEventListener('click',closeFullscreen);img.addEventListener('click',e=>e.stopPropagation());document.addEventListener('keydown',handleKeyDown)}};
    const TabManager={switchTab:async tabName=>{if(currentTab===tabName)return;currentTab=tabName;UI.updateTabsUI();await UI.renderImages();UI.updateButtonsState();UI.updateCheckboxesVisibility();StateManager.saveState()}};
    const ImageManager={toggleSelectImage:(imageName,isChecked,container)=>{const selectedSet=selectedImagesByTab.get(currentTab);isChecked?selectedSet.add(imageName):selectedSet.delete(imageName);container.classList.toggle('selected',isChecked);UI.updateSelectAllCheckbox();UI.updateButtonsState();UI.updateCheckboxesVisibility();StateManager.saveState()},deleteImage:async imageName=>{if(!confirm(`Tem certeza que deseja excluir "${Utils.removeFileExtension(imageName)}"?`))return;UI.showLoading();try{await IndexedDBManager.deleteImageBlob(imageName);const images=imageGalleryByTab.get(currentTab).filter(name=>name!==imageName);imageGalleryByTab.set(currentTab,images);selectedImagesByTab.get(currentTab).delete(imageName);await UI.renderImages();StateManager.saveState();Utils.showStatus('Imagem excluída com sucesso!')}catch(error){console.error('Erro ao excluir imagem:',error);Utils.showStatus('Erro ao excluir imagem.')}finally{UI.hideLoading()}},reorderImages:async(fromIndex,toIndex,draggedImageName)=>{const images=imageGalleryByTab.get(currentTab)||[],movedImageName=images.splice(fromIndex,1)[0];images.splice(toIndex,0,movedImageName);imageGalleryByTab.set(currentTab,images);selectedImagesByTab.get(currentTab).delete(draggedImageName);await UI.renderImages();StateManager.saveState()},deleteSelected:async()=>{const selectedNames=Array.from(selectedImagesByTab.get(currentTab)),count=selectedNames.length;if(!count||!confirm(`Excluir ${count} imagem(ns) selecionada(s)?`))return;UI.showLoading();try{for(const name of selectedNames)await IndexedDBManager.deleteImageBlob(name);const images=imageGalleryByTab.get(currentTab).filter(name=>!selectedImagesByTab.get(currentTab).has(name));imageGalleryByTab.set(currentTab,images);selectedImagesByTab.get(currentTab).clear();await UI.renderImages();StateManager.saveState();Utils.showStatus(`${count} imagens excluídas.`)}catch(error){console.error('Erro ao excluir imagens selecionadas:',error);Utils.showStatus('Erro ao excluir imagens.')}finally{UI.hideLoading()}},clearSelection:()=>(selectedImagesByTab.get(currentTab).clear(),UI.renderImages(),StateManager.saveState(),Utils.showStatus('Seleção limpa.')),handleFileSelection:async e=>{const files=Array.from(e.target.files);if(!files.length)return;UI.showLoading();if(!imageGalleryByTab.get(currentTab))imageGalleryByTab.set(currentTab,[]);if(!selectedImagesByTab.get(currentTab))selectedImagesByTab.set(currentTab,new Set());const currentImageNamesInTab=new Set(imageGalleryByTab.get(currentTab));let loadedCount=0;try{for(const file of files){if(!file.type.startsWith('image/')){console.warn(`Arquivo ignorado (não é imagem): ${file.name}`);continue}try{const processed=await ImageProcessor.processImageFile(file);if(!processed)continue;await IndexedDBManager.addImageBlob(processed.name,processed.blob);currentImageNamesInTab.has(processed.name)?console.warn(`Imagem "${processed.name}" já existe na aba atual. Conteúdo será atualizado.`):imageGalleryByTab.get(currentTab).push(processed.name);currentImageNamesInTab.add(processed.name);loadedCount++}catch(error){console.error(`Erro ao processar ${file.name}:`,error);Utils.showStatus(`Erro ao carregar ${file.name}`)}}await UI.renderImages();StateManager.saveState();Utils.showStatus(`${loadedCount} imagem(ns) carregada(s) com sucesso!`)}catch(error){console.error('Erro geral no carregamento:',error);Utils.showStatus('Erro ao carregar imagens.')}finally{UI.hideLoading()}}};
    const EventManager={setup:()=>{DOM.imageList.addEventListener('mousedown',e=>{const container=e.target.closest('.image-container');if(!container)return;longPressTimer=setTimeout(()=>(isLongPress=true,checkbox=container.querySelector('.image-checkbox'),checkbox&&(checkbox.checked=!checkbox.checked,ImageManager.toggleSelectImage(container.dataset.name,checkbox.checked,container))),500)});DOM.imageList.addEventListener('mouseup',()=>(clearTimeout(longPressTimer),isLongPress=false));DOM.imageList.addEventListener('touchstart',e=>{const container=e.target.closest('.image-container');if(!container)return;longPressTimer=setTimeout(()=>(isLongPress=true,checkbox=container.querySelector('.image-checkbox'),checkbox&&(checkbox.checked=!checkbox.checked,ImageManager.toggleSelectImage(container.dataset.name,checkbox.checked,container))),500)},{passive:true});DOM.imageList.addEventListener('touchend',()=>(clearTimeout(longPressTimer),isLongPress=false));DOM.imageList.addEventListener('click',async e=>{const container=e.target.closest('.image-container');if(!container||isLongPress)return;if(e.target.tagName==='IMG'||e.target.classList.contains('image-name')){const imageName=container.dataset.name,blob=await IndexedDBManager.getImageBlob(imageName);blob?(objectURL=Utils.createObjectURL(blob),UI.openFullscreen(objectURL,Utils.removeFileExtension(imageName))):Utils.showStatus('Erro: Imagem não encontrada para ampliar.')}else if(e.target.type==='checkbox')return;else if(DOM.body.classList.contains('show-checkboxes')){const checkbox=container.querySelector('.image-checkbox');checkbox&&(checkbox.checked=!checkbox.checked,ImageManager.toggleSelectImage(container.dataset.name,checkbox.checked,container))}});DOM.imageList.addEventListener('keydown',e=>{const container=e.target.closest('.image-container');if(!container)return;const imageName=container.dataset.name;if(e.key===' '||e.key==='Enter'){e.preventDefault();const checkbox=container.querySelector('.image-checkbox');checkbox&&(DOM.body.classList.add('show-checkboxes'),checkbox.checked=!checkbox.checked,ImageManager.toggleSelectImage(imageName,checkbox.checked,container))}if(e.key==='Delete'||e.key==='Backspace'){e.preventDefault();ImageManager.deleteImage(imageName)}});DOM.imageList.addEventListener('dragstart',e=>{const container=e.target.closest('.image-container');if(!container)return;const currentImageNames=imageGalleryByTab.get(currentTab);dragStartIndex=currentImageNames.indexOf(container.dataset.name);container.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',container.dataset.name)});DOM.imageList.addEventListener('dragover',e=>(e.preventDefault(),container=e.target.closest('.image-container'),container&&container.dataset.name!==e.dataTransfer.getData('text/plain')&&container.classList.add('drag-over'),e.dataTransfer.dropEffect='move'));DOM.imageList.addEventListener('dragleave',e=>(container=e.target.closest('.image-container'),container&&container.classList.remove('drag-over')));DOM.imageList.addEventListener('drop',e=>{e.preventDefault();const container=e.target.closest('.image-container');if(container){container.classList.remove('drag-over');const draggedImageName=e.dataTransfer.getData('text/plain'),dragEndIndex=imageGalleryByTab.get(currentTab).indexOf(container.dataset.name);dragStartIndex!==null&&dragEndIndex!==-1&&dragStartIndex!==dragEndIndex&&ImageManager.reorderImages(dragStartIndex,dragEndIndex,draggedImageName)}dragStartIndex=null});DOM.imageList.addEventListener('dragend',e=>{const allImageContainers=DOM.imageList.querySelectorAll('.image-container');allImageContainers.forEach(container=>container.classList.remove('dragging','drag-over'));dragStartIndex=null});DOM.selectAllCheckbox.addEventListener('change',()=>{const images=imageGalleryByTab.get(currentTab)||[],selectedSet=selectedImagesByTab.get(currentTab),imageContainers=DOM.imageList.querySelectorAll('.image-container');DOM.selectAllCheckbox.checked?(images.forEach(name=>selectedSet.add(name)),imageContainers.forEach(container=>(container.classList.add('selected'),container.querySelector('.image-checkbox').checked=true)):(selectedSet.clear(),imageContainers.forEach(container=>(container.classList.remove('selected'),container.querySelector('.image-checkbox').checked=false));UI.updateButtonsState();UI.updateCheckboxesVisibility();StateManager.saveState()});DOM.clearSelectionBtn.addEventListener('click',ImageManager.clearSelection);DOM.deleteSelectedBtn.addEventListener('click',ImageManager.deleteSelected);DOM.openFileDialogButton.addEventListener('click',()=>(DOM.fileInput.value='',DOM.fileInput.click()));DOM.fileInput.addEventListener('change',ImageManager.handleFileSelection);DOM.openCloudFolderButton.addEventListener('click',()=>(window.open(ONE_DRIVE_FOLDER_URL,'_blank'),Utils.showStatus('Abrindo pasta do OneDrive em uma nova aba.')));DOM.syncBtn.addEventListener('click',()=>Utils.showStatus('Funcionalidade de Sincronização em desenvolvimento...'));DOM.settingsBtn.addEventListener('click',()=>Utils.showStatus('Funcionalidade de Configurações em desenvolvimento...'))}};
    async function init(){UI.showLoading();try{await IndexedDBManager.open();await StateManager.loadState();UI.createTabs();UI.updateTabsUI();await UI.renderImages();EventManager.setup();UI.updateCheckboxesVisibility()}catch(e){console.error("Erro na inicialização:",e);Utils.showStatus("Erro ao iniciar o aplicativo. Tente recarregar a página.")}finally{UI.hideLoading()}}document.addEventListener('DOMContentLoaded',init);
  </script>
</body>
</html>
