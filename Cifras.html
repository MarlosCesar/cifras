<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seletor de Cifras</title>
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --primary-hover: #e0e7ff;
      --danger-color: #ef4444;
      --gray-light: #f3f4f6;
      --gray-medium: #e5e7eb;
      --text-color-dark: #333333;
      --text-color-light: #4b5563;
      --shadow-base: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-primary: 0 0 10px rgba(37,99,235,0.3);
      --header-bg: #1A202C;
      --header-text: #E2E8F0;
      --header-hover: #2D3748;
    }
    html, body {
      background-color: var(--gray-light);
      font-family: 'Inter', sans-serif;
      color: var(--text-color-dark);
    }
    .header-professional {
      background-color: var(--header-bg);
      color: var(--header-text);
      box-shadow: var(--shadow-base);
    }
    .header-professional button { transition: background-color .3s, transform .1s; }
    .header-professional button:hover { background-color: var(--header-hover);}
    .header-professional button:active { transform: scale(.98);}
    .tabs-custom {
      display: flex;
      justify-content: center;
      gap: .5rem;
      border-bottom: 2px solid var(--gray-medium);
      margin-bottom: 1rem;
      flex-wrap: wrap;
      padding: 0 1rem;
    }
    .tab {
      padding: .65rem 1.2rem;
      cursor: pointer;
      border-radius: .5rem .5rem 0 0;
      background: #f9fafb;
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      transition: all .2s;
      color: var(--text-color-light);
      font-weight: 500;
      user-select: none;
    }
    .tab:hover, .tab:focus-visible {
      background: var(--primary-hover);
      border-color: var(--primary-color) transparent transparent;
      color: var(--primary-dark);
    }
    .tab.active {
      background: white;
      border-color: var(--primary-color) var(--primary-color) white;
      font-weight: 600;
      color: var(--primary-dark);
      box-shadow: 0 -2px 5px rgba(0,0,0,.05);
    }
    .image-container {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid var(--gray-medium);
      border-radius: .75rem;
      cursor: pointer;
      transition: all .2s;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .image-container.selected {
      border-color: var(--primary-dark);
      background: var(--primary-hover);
      box-shadow: var(--shadow-primary);
    }
    .image-checkbox {
      position: absolute;
      left: 12px; top: 50%; transform: translateY(-50%);
      width: 24px; height: 24px;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      background: white;
      opacity: 0; pointer-events: none;
      display: flex; align-items: center; justify-content: center;
      transition: all .2s;
    }
    .image-container.selected .image-checkbox,
    .image-container.selection-mode .image-checkbox {
      opacity: 1; pointer-events: all;
    }
    .image-checkbox.checked {
      background: var(--primary-color); border-color: var(--primary-color);
    }
    .image-checkbox.checked:after {
      content: '';
      display: block;
      width: 12px; height: 6px;
      border: 2px solid white;
      border-top: none; border-right: none;
      transform: rotate(-45deg); margin-top: -2px;
    }
    .image-container img { width: 2.2cm; height: 3.3cm; object-fit: cover; border-radius: .35rem; flex-shrink: 0; box-shadow: 0 1px 4px rgba(0,0,0,0.1);}
    .image-name { font-size: .95rem; color: var(--text-color-dark); flex-grow: 1; overflow-wrap: break-word; max-width: calc(100% - 2.2cm - 12px);}
    .fullscreen-image {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.95);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999; touch-action: none;
    }
    .fullscreen-image img {
      max-width: 95vw; max-height: 95vh; object-fit: contain;
      border-radius: .75rem; box-shadow: 0 0 25px rgba(0,0,0,0.8);
      transform-origin: center center; transition: transform .25s;
    }
    .fullscreen-controls {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 15px;
      background: rgba(0,0,0,.7); padding: 12px 20px; border-radius: 8px;
    }
    .zoom-btn { background:rgba(255,255,255,.2); color:white; border:none;
      width:50px; height:50px; border-radius:50%; font-size:24px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:background-color .3s, transform .1s;}
    .zoom-btn:hover { background:rgba(255,255,255,.3);}
    .zoom-btn:active { transform:scale(.95);}
    .loading-spinner {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.6); padding: 20px; border-radius: 12px; z-index: 10000; color: white;
    }
    .loading-spinner.active { display: flex; align-items: center; justify-content: center;}
    #status-message {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000;
      opacity: 0; transition: opacity .3s; pointer-events: none; text-align: center;
    }
    #status-message.show { opacity: 1; }
    #selected-popup {
      display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: var(--primary-color); color: white; padding: 10px 30px; border-radius: 30px;
      font-weight: 600; font-size: 1rem; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      animation: popup-in .2s;
    }
    #selected-popup.show { display: block; }
    @keyframes popup-in { from { opacity: 0; transform: translateX(-50%) scale(.95);} to { opacity: 1; transform: translateX(-50%) scale(1);}}
    @media (max-width: 640px) {
      .image-container img { width: 1.8cm; height: 2.7cm;}
      .image-name { font-size: .875rem; max-width: calc(100% - 1.8cm - 10px);}
      .tabs-custom { gap:.15rem; }
      .tab { font-size:.92rem; padding:.45rem .7rem;}
      .flex.flex-wrap.gap-2 { flex-direction: row; gap: .5rem;}
    }
  </style>
</head>
<body>
  <header class="header-professional p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-semibold tracking-wide">Seletor de Cifras</h1>
      <div class="flex items-center space-x-4">
        <button id="sync-btn" class="p-2 rounded-full" aria-label="Sincronizar" title="Sincronizar">
          <i class="fas fa-sync-alt text-lg" aria-hidden="true"></i>
        </button>
        <button id="settings-btn" class="p-2 rounded-full" aria-label="Configurações" title="Configurações">
          <i class="fas fa-cog text-lg" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </header>
  <main class="container mx-auto p-4 flex flex-col gap-4 main-content-area" role="main">
    <section class="w-full bg-white rounded-xl shadow-md overflow-hidden flex flex-col" aria-label="Seletor de músicas e imagens">
      <div class="p-4 bg-gray-50 border-b flex flex-wrap sm:flex-row sm:items-center sm:justify-end gap-2">
        <div class="flex flex-wrap gap-2 w-full justify-center sm:justify-end">
          <button id="open-cloud-folder" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center" aria-label="Buscar cifras na nuvem (OneDrive)" title="Buscar em Nuvem">
            <i class="fas fa-cloud mr-2" aria-hidden="true"></i> Buscar em Nuvem
          </button>
          <button id="open-file-dialog" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" aria-label="Buscar cifras localmente" title="Buscar cifras localmente">
            <i class="fas fa-folder-open mr-2" aria-hidden="true"></i> Buscar Local
          </button>
          <input type="file" id="file-input" class="hidden" accept="image/*" multiple aria-hidden="true" tabindex="-1" />
        </div>
      </div>
      <nav class="tabs-custom" id="tabs-container" role="tablist" aria-label="Abas das categorias de cifras"></nav>
      <div class="flex gap-4 items-center p-2 px-4 bg-gray-50 border-b" id="selection-controls" style="display:none;">
        <button id="select-all-btn" class="text-blue-600 hover:text-blue-800 flex items-center gap-2" style="display:none;">
          <i class="fas fa-check-double"></i> Selecionar todas
        </button>
        <button id="clear-selection-btn" class="text-gray-700 hover:text-gray-900 flex items-center gap-2">
          <i class="fas fa-times"></i> Limpar
        </button>
        <button id="delete-selected-btn" class="text-red-600 hover:text-red-800 flex items-center gap-2 ml-2">
          <i class="fas fa-trash-alt"></i> Excluir
        </button>
      </div>
      <div class="p-4 flex flex-col gap-4 flex-1">
        <div id="image-list" class="flex flex-col gap-4" aria-live="polite" aria-atomic="true">
          <p class="text-center text-gray-500 py-8">Nenhuma cifra selecionada.</p>
        </div>
      </div>
    </section>
  </main>
  <div id="loading-spinner" class="loading-spinner">
    <i class="fas fa-spinner fa-spin fa-3x text-blue-600" aria-hidden="true"></i>
    <span class="sr-only">Carregando...</span>
  </div>
  <div id="status-message" aria-live="polite"></div>
  <div id="selected-popup"></div>
  <script>
    // ------------------- IndexedDB Helper -------------------
    const DB_NAME = 'CifrasDB';
    const DB_VERSION = 1;
    const STORE_IMAGES = 'images';
    const STORE_STATE = 'state';

    const IndexedDB = {
      db: null,
      open: () => new Promise((resolve, reject) => {
        if (IndexedDB.db) return resolve(IndexedDB.db);
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_IMAGES))
            db.createObjectStore(STORE_IMAGES, { keyPath: 'key' });
          if (!db.objectStoreNames.contains(STORE_STATE))
            db.createObjectStore(STORE_STATE, { keyPath: 'key' });
        };
        req.onsuccess = e => { IndexedDB.db = e.target.result; resolve(IndexedDB.db); };
        req.onerror = e => reject(e.target.error);
      }),
      putImage: (key, blob) => IndexedDB.open().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_IMAGES], 'readwrite');
        tx.objectStore(STORE_IMAGES).put({ key, blob });
        tx.oncomplete = resolve;
        tx.onerror = e => reject(e.target.error);
      })),
      getImage: key => IndexedDB.open().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_IMAGES], 'readonly');
        const req = tx.objectStore(STORE_IMAGES).get(key);
        req.onsuccess = () => resolve(req.result ? req.result.blob : null);
        req.onerror = e => reject(e.target.error);
      })),
      deleteImage: key => IndexedDB.open().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_IMAGES], 'readwrite');
        tx.objectStore(STORE_IMAGES).delete(key);
        tx.oncomplete = resolve;
        tx.onerror = e => reject(e.target.error);
      })),
      saveState: state => IndexedDB.open().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_STATE], 'readwrite');
        tx.objectStore(STORE_STATE).put({ key: "state", ...state });
        tx.oncomplete = resolve;
        tx.onerror = e => reject(e.target.error);
      })),
      loadState: () => IndexedDB.open().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_STATE], 'readonly');
        const req = tx.objectStore(STORE_STATE).get("state");
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = e => reject(e.target.error);
      }))
    };

    // ------------------- Utilitários e Estado -------------------
    function showLoading(show) {
      document.getElementById('loading-spinner').classList.toggle('active', show);
    }
    function showStatus(msg) {
      const el = document.getElementById('status-message');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2500);
    }
    function showSelectedPopup(count) {
      const el = document.getElementById('selected-popup');
      if (count > 0) {
        el.textContent = `${count} selecionada${count > 1 ? "s" : ""}`;
        el.classList.add('show');
      } else {
        el.classList.remove('show');
        el.textContent = "";
      }
    }
    function saveAppState() {
      const imagesObj = {};
      tabs.forEach(tab => imagesObj[tab] = imageGalleryByTab.get(tab));
      const selectedObj = {};
      tabs.forEach(tab => selectedObj[tab] = Array.from(selectedImagesByTab.get(tab)));
      IndexedDB.saveState({ imagesObj, selectedObj, currentTab });
    }
    function restoreAppState(state) {
      if (!state) {
        tabs.forEach(tab => {
          imageGalleryByTab.set(tab, []);
          selectedImagesByTab.set(tab, new Set());
        });
        return;
      }
      tabs.forEach(tab => {
        imageGalleryByTab.set(tab, state.imagesObj[tab] || []);
        selectedImagesByTab.set(tab, new Set(state.selectedObj[tab] || []));
      });
      currentTab = state.currentTab || tabs[0];
    }
    function updateSelectionControls() {
      const set = selectedImagesByTab.get(currentTab);
      const total = (imageGalleryByTab.get(currentTab) || []).length;
      const selectionControls = document.getElementById('selection-controls');
      const selectAllBtn = document.getElementById('select-all-btn');
      selectionControls.style.display = set.size > 0 ? "flex" : "none";
      selectAllBtn.style.display = (total > 1 && set.size < total) ? "inline-flex" : "none";
    }

    // ------------------- Fullscreen -------------------
    function openFullscreen(src, alt) {
      const overlay = document.createElement('div');
      overlay.className = 'fullscreen-image';
      overlay.setAttribute('role', 'dialog');
      overlay.setAttribute('aria-modal', 'true');
      overlay.setAttribute('aria-label', `Visualização da imagem ${alt}`);
      const img = document.createElement('img');
      img.src = src;
      img.alt = alt;
      overlay.appendChild(img);

      // Zoom e controles (pode adicionar conforme necessidade)
      overlay.onclick = () => { overlay.remove(); };
      document.body.appendChild(overlay);
    }

    // ------------------- Geração de Tabs e Imagens -------------------
    function renderTabs() {
      const tabsContainer = document.getElementById('tabs-container');
      tabsContainer.innerHTML = "";
      tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = "tab" + (currentTab === tab ? " active" : "");
        btn.textContent = tab;
        btn.onclick = () => {
          currentTab = tab;
          renderTabs();
          renderImages();
          saveAppState();
        };
        tabsContainer.appendChild(btn);
      });
    }
    function createImageElement(imageName, imageBlob) {
  const container = document.createElement('div');
  container.className = 'image-container';
  container.setAttribute('draggable', 'true');
  container.setAttribute('tabindex', '0');
  container.setAttribute('role', 'checkbox');
  container.setAttribute('aria-checked', selectedImagesByTab.get(currentTab).has(imageName));
  container.dataset.name = imageName;
  if (selectedImagesByTab.get(currentTab).has(imageName)) container.classList.add('selected');

  // Checkbox visual
  const checkbox = document.createElement('div');
  checkbox.className = 'image-checkbox';
  if (selectedImagesByTab.get(currentTab).has(imageName)) checkbox.classList.add('checked');
  checkbox.onclick = e => { e.stopPropagation(); toggleSelect(imageName, container); };
  container.appendChild(checkbox);

  // Imagem
  const img = document.createElement('img');
  const objectURL = URL.createObjectURL(imageBlob);
  img.src = objectURL;
  img.alt = imageName;
  container.appendChild(img);

  // Nome
  const span = document.createElement('span');
  span.className = 'image-name';
  span.textContent = imageName.replace(/\.[^/.]+$/, "");
  container.appendChild(span);

  // --- Eventos para seleção e drag ---
  let longPressTimeout = null;
  let dragActivated = false;
  let isDragging = false;

  // Mobile: long-press para seleção ou drag
  container.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1) return;
    dragActivated = false;
    isDragging = false;
    longPressTimeout = setTimeout(() => {
      if (!longPressUsed) {
        // Primeira seleção via long press
        isSelectionMode = true;
        longPressUsed = true;
        toggleSelect(imageName, container);
      } else {
        // Já está em seleção: ativa drag
        dragActivated = true;
        isDragging = true;
        container.classList.add('dragging');
        dragStartIndex = Array.from(document.getElementById('image-list').children).indexOf(container);
      }
    }, 400);
  }, {passive: true});

  container.addEventListener('touchmove', function(e) {
    if (dragActivated && isDragging && e.touches.length === 1) {
      // efeito visual opcional
    } else {
      clearTimeout(longPressTimeout);
    }
  }, {passive: true});

  container.addEventListener('touchend', function(e) {
    clearTimeout(longPressTimeout);
    if (dragActivated && isDragging) {
      container.classList.remove('dragging');
      // Encontrar destino
      const containers = Array.from(document.getElementById('image-list').children);
      let toIndex = containers.indexOf(document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY));
      if (toIndex === -1) toIndex = containers.length - 1;
      reorderImages(dragStartIndex, toIndex);
      // Limpa seleção após drag
      selectedImagesByTab.get(currentTab).clear();
      isSelectionMode = false;
      longPressUsed = false;
      renderImages();
    } else if (!isSelectionMode && !longPressUsed) {
      // Tap curto fora da seleção: abre fullscreen
      openFullscreen(objectURL, imageName);
    } else if (isSelectionMode && longPressUsed) {
      // Se já está em seleção, tap curto seleciona
      toggleSelect(imageName, container);
    }
  }, {passive: true});

  // Desktop: long-press com mouse para seleção ou drag
  container.addEventListener('mousedown', function(e) {
    if (e.button !== 0) return;
    dragActivated = false;
    isDragging = false;
    longPressTimeout = setTimeout(() => {
      if (!longPressUsed) {
        isSelectionMode = true;
        longPressUsed = true;
        toggleSelect(imageName, container);
      } else {
        dragActivated = true;
        isDragging = true;
        container.classList.add('dragging');
        dragStartIndex = Array.from(document.getElementById('image-list').children).indexOf(container);
      }
    }, 400);
  });
  container.addEventListener('mousemove', function() {
    clearTimeout(longPressTimeout);
  });
  container.addEventListener('mouseup', function(e) {
    clearTimeout(longPressTimeout);
    if (dragActivated && isDragging) {
      container.classList.remove('dragging');
      // Encontrar destino
      const containers = Array.from(document.getElementById('image-list').children);
      let toIndex = containers.indexOf(document.elementFromPoint(e.clientX, e.clientY));
      if (toIndex === -1) toIndex = containers.length - 1;
      reorderImages(dragStartIndex, toIndex);
      // Limpa seleção após drag
      selectedImagesByTab.get(currentTab).clear();
      isSelectionMode = false;
      longPressUsed = false;
      renderImages();
    } else if (!isSelectionMode && !longPressUsed) {
      openFullscreen(objectURL, imageName);
    } else if (isSelectionMode && longPressUsed) {
      toggleSelect(imageName, container);
    }
  });
  container.addEventListener('mouseleave', function() {
    clearTimeout(longPressTimeout);
  });

  // Drag & drop HTML5 para desktop (fallback para mouse users)
  container.addEventListener('dragstart', function(e) {
    // Ativa seleção para arrastar
    if (!isSelectionMode) {
      isSelectionMode = true;
      longPressUsed = true;
      toggleSelect(imageName, container);
    }
    container.classList.add('dragging');
    dragStartIndex = Array.from(document.getElementById('image-list').children).indexOf(container);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', imageName);
  });

  return container;
}
    async function renderImages() {
      const list = document.getElementById('image-list');
      list.innerHTML = "";
      const names = imageGalleryByTab.get(currentTab) || [];
      if (!names.length) {
        list.innerHTML = `<p class="text-center text-gray-500 py-8">Nenhuma cifra selecionada.</p>`;
      } else {
        for (let name of names) {
          const blob = await IndexedDB.getImage(`${currentTab}:${name}`);
          if (!blob) continue;
          const container = createImageElement(name, blob);
          list.appendChild(container);
        }
      }
      updateSelectionControls();
    }
    function reorderImages(fromIndex, toIndex) {
      const arr = imageGalleryByTab.get(currentTab) || [];
      if (fromIndex === toIndex || fromIndex < 0 || toIndex < 0) return;
      const [item] = arr.splice(fromIndex, 1);
      arr.splice(toIndex, 0, item);
      imageGalleryByTab.set(currentTab, arr);
      saveAppState();
    }
    function toggleSelect(name, container) {
      const set = selectedImagesByTab.get(currentTab);
      if (set.has(name)) set.delete(name);
      else set.add(name);
      renderImages();
      saveAppState();
      showSelectedPopup(set.size);
    }

    // ------------------- Drag & Drop container listeners -------------------
    document.getElementById('image-list').addEventListener('dragover', function(e) {
      e.preventDefault();
      const dragging = document.querySelector('.dragging');
      if (!dragging) return;
      const after = getDragAfterElement(this, e.clientY);
      this.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      if (after) after.classList.add('drag-over');
    });
    document.getElementById('image-list').addEventListener('drop', function(e) {
      e.preventDefault();
      const dragging = document.querySelector('.dragging');
      if (!dragging) return;
      const containers = Array.from(this.children);
      const fromIndex = containers.indexOf(dragging);
      const after = getDragAfterElement(this, e.clientY);
      let toIndex = after ? containers.indexOf(after) : containers.length - 1;
      if (fromIndex < toIndex) toIndex--;
      reorderImages(fromIndex, toIndex);
      dragging.classList.remove('dragging');
      this.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      // Limpa seleção após drag
      selectedImagesByTab.get(currentTab).clear();
      isSelectionMode = false;
      longPressUsed = false;
      renderImages();
    });
    function getDragAfterElement(container, y) {
      const els = [...container.querySelectorAll('.image-container:not(.dragging)')];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return {offset, element: child};
        else return closest;
      }, {offset: -Infinity, element: null}).element;
    }

    // ------------------- Importação Local -------------------
    document.getElementById('open-file-dialog').onclick = () => {
      document.getElementById('file-input').click();
    };
    document.getElementById('file-input').onchange = async function(e) {
      showLoading(true);
      const files = Array.from(e.target.files);
      for (let file of files) {
        const reader = new FileReader();
        await new Promise(resolve => {
          reader.onload = () => {
            IndexedDB.putImage(`${currentTab}:${file.name}`, new Blob([reader.result]));
            if (!imageGalleryByTab.get(currentTab).includes(file.name)) {
              imageGalleryByTab.get(currentTab).push(file.name);
            }
            resolve();
          };
          reader.readAsArrayBuffer(file);
        });
      }
      renderImages();
      saveAppState();
      showLoading(false);
      showStatus(`${files.length} cifra(s) adicionada(s)!`);
    };

    // ------------------- Botões de seleção -------------------
    document.getElementById('select-all-btn').onclick = function() {
      const set = selectedImagesByTab.get(currentTab);
      const names = imageGalleryByTab.get(currentTab) || [];
      names.forEach(name => set.add(name));
      renderImages();
      saveAppState();
      showSelectedPopup(set.size);
    };
    document.getElementById('clear-selection-btn').onclick = function() {
      selectedImagesByTab.get(currentTab).clear();
      isSelectionMode = false;
      longPressUsed = false;
      renderImages();
      saveAppState();
      showSelectedPopup(0);
    };
    document.getElementById('delete-selected-btn').onclick = function() {
      const set = selectedImagesByTab.get(currentTab);
      if (!set.size) return;
      if (!confirm(`Excluir ${set.size} cifra(s) selecionada(s)?`)) return;
      showLoading(true);
      const names = Array.from(set);
      Promise.all(names.map(name => IndexedDB.deleteImage(`${currentTab}:${name}`)))
        .then(() => {
          imageGalleryByTab.set(currentTab, imageGalleryByTab.get(currentTab).filter(name => !set.has(name)));
          set.clear();
          isSelectionMode = false;
          longPressUsed = false;
          renderImages();
          saveAppState();
          showStatus("Cifras excluídas!");
          showSelectedPopup(0);
        })
        .finally(() => showLoading(false));
    };

    // ------------------- OneDrive -------------------
    document.getElementById('open-cloud-folder').onclick = () => {
      window.open("https://1drv.ms/f/c/a71268bf66931c02/EpYyUsypAQhGgpWC9YuvE54BD_o9NX9tRar0piSzq4V4Xg", "_blank");
      showStatus('Abrindo pasta do OneDrive em uma nova aba.');
    };

    // ------------------- Inicialização -------------------
    (async function() {
      showLoading(true);
      const state = await IndexedDB.loadState();
      restoreAppState(state);
      renderTabs();
      await renderImages();
      showLoading(false);
    })();
  </script>
</body>
</html>