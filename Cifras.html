<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seletor de Cifras - Google Drive</title>
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* Variáveis CSS para um tema mais profissional e fácil manutenção */
    :root {
      --primary-color: #3b82f6; /* Azul primário */
      --primary-dark: #2563eb; /* Azul mais escuro para hover/ativo */
      --primary-hover: #e0e7ff; /* Azul muito claro para fundo de hover */
      --danger-color: #ef4444; /* Vermelho para ações perigosas */
      --danger-dark: #dc2626; /* Vermelho mais escuro */
      --gray-light: #f3f4f6; /* Cinza claro para o background geral */
      --gray-medium: #e5e7eb; /* Cinza médio para bordas/divisores */
      --text-color-dark: #333333; /* Texto escuro quase preto */
      --text-color-light: #4b5563; /* Texto cinza escuro */
      --shadow-base: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-primary: 0 0 10px rgba(37, 99, 235, 0.3);

      /* Cores do cabeçalho */
      --header-bg: #1A202C; /* Cinza bem escuro para o cabeçalho */
      --header-text: #E2E8F0; /* Cinza claro para o texto do cabeçalho */
      --header-hover: #2D3748; /* Tom um pouco mais claro para hover dos botões do cabeçalho */
    }

    html, body {
      /* Garante que o overflow-x seja escondido para evitar barras de rolagem horizontais em mobile */
      overflow-x: hidden; 
      overflow-y: auto;
      background-color: var(--gray-light);
      font-family: 'Inter', sans-serif; /* Usando a fonte Inter */
      color: var(--text-color-dark); /* Cor de texto padrão */
    }

    /* Estilo do cabeçalho profissional */
    .header-professional {
      background-color: var(--header-bg);
      color: var(--header-text);
      box-shadow: var(--shadow-base); /* Sombra suave para o cabeçalho */
    }

    .header-professional button {
      transition: background-color 0.3s ease, transform 0.1s ease; /* Transição suave e pequena escala no clique */
      display: flex; /* Para alinhar ícone e texto se houver */
      align-items: center;
      justify-content: center;
    }

    .header-professional button:hover {
      background-color: var(--header-hover);
    }

    .header-professional button:active {
        transform: scale(0.98); /* Pequeno efeito de clique */
    }

    /* Estilos para as abas */
    .tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 2px solid var(--gray-medium); /* Borda inferior para separar as abas do conteúdo */
      margin-bottom: 1rem;
      flex-wrap: wrap; /* Permite que as abas quebrem a linha em telas menores */
      padding: 0 1rem; /* Padding horizontal para não colar nas bordas em mobile */
    }

    .tab {
      padding: 0.65rem 1.2rem; /* Um pouco mais de padding */
      cursor: pointer;
      border-radius: 0.5rem 0.5rem 0 0;
      background-color: #f9fafb;
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
      outline-offset: 2px;
      color: var(--text-color-light); /* Cor do texto das abas não selecionadas */
      font-weight: 500; /* Um pouco mais de peso */
    }

    [role="tab"] {
      user-select: none;
    }

    .tab:hover,
    .tab:focus-visible {
      background-color: var(--primary-hover);
      border-color: var(--primary-color) transparent transparent;
      outline: none;
      color: var(--primary-dark);
    }

    .tab.active {
      background-color: white;
      border-color: var(--primary-color) var(--primary-color) white;
      font-weight: 600;
      color: var(--primary-dark);
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* Sombra sutil na aba ativa */
    }

    /* Estilo para o contêiner de imagem individual */
    .image-container {
      display: flex;
      align-items: center;
      gap: 12px; /* Aumentei o espaçamento entre imagem e nome */
      padding: 12px; /* Mais padding interno */
      border: 1px solid var(--gray-medium); /* Borda sutil */
      border-radius: 0.75rem; /* Bordas mais arredondadas */
      overflow: hidden;
      cursor: pointer; /* Cursor de ponteiro para indicar que é clicável */
      transition: all 0.2s ease;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Sombra mais sutil por padrão */
      position: relative; /* Para posicionar o checkbox */
    }

    .image-container:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 3px; /* Aumentei o offset para melhor visibilidade */
    }

    .image-container.selected {
      border-color: var(--primary-dark);
      box-shadow: var(--shadow-primary); /* Sombra primária quando selecionado */
      background-color: var(--primary-hover); /* Fundo levemente azulado quando selecionado */
    }

    /* Estilos para o checkbox */
    .image-container .image-checkbox {
        position: absolute; /* Posiciona o checkbox dentro do container */
        top: 8px; /* Ajuste a posição conforme necessário */
        left: 8px; /* Ajuste a posição conforme necessário */
        z-index: 10; /* Garante que o checkbox esteja acima da imagem */
        opacity: 0; /* Oculto por padrão */
        pointer-events: none; /* Não interage com o mouse por padrão */
        transition: opacity 0.2s ease;
    }

    /* Regra para mostrar checkboxes quando a classe 'show-checkboxes' estiver ativa */
    .show-checkboxes .image-container .image-checkbox {
        opacity: 1;
        pointer-events: all; /* Permite interação quando visível */
    }
    /* Também mostra o "Selecionar todas" quando checkboxes são visíveis */
    .show-checkboxes #select-all-container {
      display: flex !important; /* Força a exibição do container "Selecionar todas" */
    }

    /* Estilos para drag-and-drop */
    .drag-over {
      border: 2px dashed var(--primary-dark) !important; /* Borda mais visível para drag-over */
      background-color: rgba(59, 130, 246, 0.1) !important; /* Fundo levemente azulado */
    }

    .image-container.dragging {
      opacity: 0.4; /* Reduz a opacidade para indicar que está sendo arrastado */
      transform: scale(0.98); /* Pequeno encolhimento visual */
    }

    .image-container img {
      width: 2.2cm; /* Ligeiramente maior */
      height: 3.3cm; /* Ligeiramente maior */
      object-fit: cover;
      border-radius: 0.35rem; /* Bordas um pouco mais arredondadas */
      flex-shrink: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1); /* Sombra sutil na imagem miniatura */
      cursor: zoom-in; /* Cursor de zoom para a imagem */
    }

    .image-name {
      font-size: 0.95rem; /* Aumentei ligeiramente o tamanho da fonte */
      color: var(--text-color-dark);
      flex-grow: 1; /* Permite que o nome ocupe o espaço restante */
      overflow-wrap: break-word; /* Garante que nomes longos quebrem a linha */
      word-break: break-word; /* Para compatibilidade */
      max-width: calc(100% - 2.2cm - 12px); /* Ajusta a largura máxima para o nome, considerando a imagem e o gap */
      line-height: 1.4; /* Melhor espaçamento entre linhas */
      cursor: zoom-in; /* Cursor de zoom para o nome */
    }

    /* Estilo para a visualização em tela cheia - MODIFICADO PARA OCUPAR TODA A TELA */
    .fullscreen-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: zoom-out;
      z-index: 9999;
      touch-action: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .fullscreen-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: transform 0.25s ease;
      transform-origin: center center;
      margin: 0;
      padding: 0;
    }

    .fullscreen-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      background: rgba(0,0,0,0.7);
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10000;
    }

    .zoom-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }

    .zoom-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .zoom-btn:active {
        transform: scale(0.95);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0,0,0,0.6);
      padding: 20px;
      border-radius: 12px;
      z-index: 10000;
      color: white;
    }

    .loading-spinner.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Mensagem de status */
    #status-message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      text-align: center;
    }

    #status-message.show {
      opacity: 1;
    }

    /* Media Queries para responsividade */
    @media (max-width: 640px) {
      .header-professional h1 {
        font-size: 1.5rem;
      }
      .header-professional .space-x-4 {
        gap: 0.5rem;
      }
      .header-professional button {
        padding: 0.6rem;
      }

      .tabs {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.35rem;
        padding: 0 0.5rem;
      }
      .tab {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }

      .main-content-area {
        padding: 0.75rem;
      }

      .image-container {
        flex-direction: row;
        align-items: center;
        gap: 10px;
        padding: 10px;
      }

      .image-container img {
        width: 1.8cm;
        height: 2.7cm;
      }

      .image-name {
        font-size: 0.875rem;
        max-width: calc(100% - 1.8cm - 10px);
      }

      .flex-wrap.gap-2 {
        flex-direction: column;
        width: 100%;
      }
      .flex-wrap.gap-2 button {
        width: 100%;
        justify-content: center;
      }
      .flex-wrap.gap-2 button i {
        margin-right: 0.5rem;
      }

      .fullscreen-controls {
          flex-direction: row;
          gap: 10px;
          padding: 10px 15px;
      }
      .zoom-btn {
          width: 45px;
          height: 45px;
          font-size: 22px;
      }
      
      /* Ajustes específicos para tela cheia em mobile */
      .fullscreen-image img {
        width: auto;
        height: auto;
        max-width: 100vw;
        max-height: 100vh;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
        .tabs {
            justify-content: flex-start;
            padding: 0 1.5rem;
        }
        .tab {
            padding: 0.6rem 1.1rem;
            font-size: 0.95rem;
        }
        .image-container {
            padding: 10px;
            gap: 10px;
        }
        .image-container img {
            width: 2cm;
            height: 3cm;
        }
        .image-name {
            font-size: 0.9rem;
            max-width: calc(100% - 2cm - 10px);
        }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
  <header class="header-professional p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-semibold tracking-wide">Seletor de Cifras</h1>
      <div class="flex items-center space-x-4">
        <button id="sync-btn" class="p-2 rounded-full" aria-label="Sincronizar" title="Sincronizar">
          <i class="fas fa-sync-alt text-lg" aria-hidden="true"></i>
        </button>
        <button id="settings-btn" class="p-2 rounded-full" aria-label="Configurações" title="Configurações">
          <i class="fas fa-cog text-lg" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </header>
  <main class="container mx-auto p-4 flex flex-col gap-4 main-content-area" role="main">
    <section class="w-full bg-white rounded-xl shadow-md overflow-hidden flex flex-col" aria-label="Seletor de músicas e imagens">
      <div class="p-4 bg-gray-50 border-b flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <h2 class="font-semibold text-xl text-gray-700">Minhas Cifras</h2>
        <div class="flex flex-wrap gap-2 justify-end">
          <button id="open-cloud-folder" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center" aria-label="Buscar cifras no Google Drive" title="Buscar cifras no Google Drive">
            <i class="fas fa-cloud mr-2" aria-hidden="true"></i> Buscar no Google Drive
          </button>
          <button id="open-file-dialog" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" aria-label="Buscar cifras localmente" title="Buscar cifras localmente">
            <i class="fas fa-folder-open mr-2" aria-hidden="true"></i> Buscar Local
          </button>
          <input type="file" id="file-input" class="hidden" accept="image/*" multiple aria-hidden="true" tabindex="-1" />
        </div>
      </div>
      <nav class="tabs" id="tabs-container" role="tablist" aria-label="Abas das categorias de cifras"></nav>
      <div class="p-4 flex flex-col gap-4 flex-1">
        <div id="select-all-container" class="flex flex-wrap items-center gap-4 mb-2 hidden">
          <label class="inline-flex items-center gap-2 cursor-pointer text-gray-700 font-medium" for="select-all">
            <input type="checkbox" id="select-all" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" aria-label="Selecionar todas as imagens" />
            <span>Selecionar todas</span>
          </label>
          <button id="clear-selection-btn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center" disabled aria-disabled="true" aria-label="Limpar seleção">
            <i class="fas fa-undo mr-2" aria-hidden="true"></i> Limpar seleção
          </button>
          <button id="delete-selected-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center" disabled aria-disabled="true" aria-label="Excluir imagens selecionadas">
            <i class="fas fa-trash-alt mr-2" aria-hidden="true"></i> Excluir selecionadas
          </button>
        </div>
        <div id="image-list" class="flex flex-col gap-4" aria-live="polite" aria-atomic="true">
          <p class="text-center text-gray-500 py-8">Nenhuma imagem encontrada nesta categoria.</p>
        </div>
      </div>
    </section>
  </main>
  <div id="loading-spinner" class="loading-spinner">
    <i class="fas fa-spinner fa-spin fa-3x text-blue-600" aria-hidden="true"></i>
    <span class="sr-only">Carregando...</span>
  </div>
  <div id="status-message" aria-live="polite"></div>

  <!-- Modal para seleção de arquivos do Google Drive -->
  <div id="gdrive-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Selecionar Cifras do Google Drive</h3>
        <button id="modal-close" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="gdrive-file-list" class="file-list">
          <p class="text-center text-gray-500 py-4">Carregando arquivos do Google Drive...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-cancel" class="modal-button modal-button-secondary">Cancelar</button>
        <button id="modal-import" class="modal-button modal-button-primary" disabled>Importar Selecionados</button>
      </div>
    </div>
  </div>
  <script>
    // ====== CONFIGURAÇÕES DO GOOGLE DRIVE ======
    const GDRIVE_CONFIG = {
      apiKey: 'SUA_API_KEY_AQUI',
      clientId: 'SEU_CLIENT_ID.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/drive.readonly',
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      folderId: '1OzrvB4NCBRTDgMsE_AhQy0b11bdn3v82'
    };

    // ====== ABAS ======
    const tabs = ["Domingo Manhã", "Domingo Noite", "Segunda", "Quarta", "Culto Jovem", "Santa Ceia", "Outros"];
    let currentTab = tabs[0];
    let filesByTab = new Map();
    tabs.forEach(tab => filesByTab.set(tab, []));
    // ====== DOM ======
    const DOM = {
      tabsContainer: document.getElementById('tabs-container'),
      imageList: document.getElementById('image-list'),
      openFileDialogButton: document.getElementById('open-file-dialog'),
      openCloudFolderButton: document.getElementById('open-cloud-folder'),
      fileInput: document.getElementById('file-input'),
      selectAllContainer: document.getElementById('select-all-container'),
      selectAllCheckbox: document.getElementById('select-all'),
      deleteSelectedBtn: document.getElementById('delete-selected-btn'),
      clearSelectionBtn: document.getElementById('clear-selection-btn'),
      syncBtn: document.getElementById('sync-btn'),
      settingsBtn: document.getElementById('settings-btn'),
      loadingSpinner: document.getElementById('loading-spinner'),
      statusMessage: document.getElementById('status-message'),
      body: document.body,
      gdriveModal: document.getElementById('gdrive-modal'),
      gdriveFileList: document.getElementById('gdrive-file-list'),
      modalClose: document.getElementById('modal-close'),
      modalCancel: document.getElementById('modal-cancel'),
      modalImport: document.getElementById('modal-import')
    };

    // ====== GOOGLE DRIVE API ======
    let gapiInited = false;
    let gisInited = false;
    let tokenClient = null;
    let gdriveFiles = [];
    let selectedDriveFiles = new Set();

    function showLoading(msg) {
      DOM.loadingSpinner.classList.add('active');
      if (msg) showStatus(msg);
    }
    function hideLoading() { DOM.loadingSpinner.classList.remove('active'); }
    function showStatus(msg) {
      DOM.statusMessage.textContent = msg;
      DOM.statusMessage.classList.add('show');
      setTimeout(() => DOM.statusMessage.classList.remove('show'), 3000);
    }

    function createTabs() {
      DOM.tabsContainer.innerHTML = '';
      tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = 'tab';
        btn.textContent = tab;
        btn.onclick = () => { currentTab = tab; updateTabsUI(); renderImages(); };
        DOM.tabsContainer.appendChild(btn);
      });
      updateTabsUI();
    }
    function updateTabsUI() {
      DOM.tabsContainer.querySelectorAll('.tab').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === currentTab);
      });
    }
    function renderImages() {
      const files = filesByTab.get(currentTab) || [];
      DOM.imageList.innerHTML = '';
      if (files.length === 0) {
        const p = document.createElement('p');
        p.className = 'text-center text-gray-500 py-8';
        p.textContent = 'Nenhuma imagem encontrada nesta categoria.';
        DOM.imageList.appendChild(p);
      } else {
        files.forEach(file => {
          const d = document.createElement('div');
          d.className = 'image-container';
          const img = document.createElement('img');
          img.src = `https://drive.google.com/uc?id=${file.id}`;
          img.alt = file.name;
          img.title = "Clique para ampliar";
          img.onclick = () => openFullscreen(img.src, file.name);
          const name = document.createElement('span');
          name.className = 'image-name';
          name.textContent = file.name;
          name.title = "Clique para ampliar";
          name.onclick = () => openFullscreen(img.src, file.name);
          d.appendChild(img);
          d.appendChild(name);
          DOM.imageList.appendChild(d);
        });
      }
    }

    // ========== FULLSCREEN ==========
    function openFullscreen(src, alt) {
      const overlay = document.createElement('div');
      overlay.className = 'fullscreen-image';
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100vw';
      overlay.style.height = '100vh';
      overlay.style.background = 'rgba(0,0,0,0.95)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';
      overlay.style.cursor = 'zoom-out';
      overlay.onclick = () => document.body.removeChild(overlay);

      const img = document.createElement('img');
      img.src = src;
      img.alt = alt;
      img.style.maxWidth = '90vw';
      img.style.maxHeight = '90vh';
      overlay.appendChild(img);
      document.body.appendChild(overlay);
    }

    // ========== Google Auth and Drive ==========
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }
    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: GDRIVE_CONFIG.apiKey,
        discoveryDocs: GDRIVE_CONFIG.discoveryDocs,
      });
      gapiInited = true;
    }
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GDRIVE_CONFIG.clientId,
        scope: GDRIVE_CONFIG.scope,
        callback: '', // Set later
      });
      gisInited = true;
    }

    function ensureGoogleAuth(callback) {
      if (!gapiInited || !gisInited) {
        showStatus('Google API não inicializada...');
        return;
      }
      tokenClient.callback = async (resp) => {
        if (resp.error) {
          alert('Erro na autenticação Google: ' + resp.error);
          return;
        }
        callback();
      };
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        callback();
      }
    }

    async function listFilesInDriveFolder(folderId) {
      showLoading('Buscando arquivos no Google Drive...');
      try {
        let files = [];
        let pageToken = null;
        do {
          const res = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and trashed = false and (mimeType contains 'image/')`,
            fields: "nextPageToken, files(id, name, mimeType)",
            pageToken: pageToken || undefined
          });
          files = files.concat(res.result.files);
          pageToken = res.result.nextPageToken;
        } while (pageToken);
        gdriveFiles = files;
        return files;
      } catch (e) {
        showStatus('Erro ao buscar arquivos: ' + e.message);
        return [];
      } finally {
        hideLoading();
      }
    }

    function showDriveModal() {
      DOM.gdriveModal.classList.remove('hidden');
      DOM.gdriveFileList.innerHTML = '<p class="text-center text-gray-500 py-4">Carregando arquivos do Google Drive...</p>';
      selectedDriveFiles.clear();
      DOM.modalImport.disabled = true;
    }
    function hideDriveModal() {
      DOM.gdriveModal.classList.add('hidden');
      DOM.gdriveFileList.innerHTML = '';
      selectedDriveFiles.clear();
    }

    function updateDriveFileList() {
      DOM.gdriveFileList.innerHTML = '';
      if (gdriveFiles.length === 0) {
        DOM.gdriveFileList.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum arquivo de imagem encontrado.</p>';
        return;
      }
      gdriveFiles.forEach((file, idx) => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.tabIndex = 0;
        const icon = document.createElement('i');
        icon.className = 'fas fa-file-image file-icon';
        const name = document.createElement('span');
        name.className = 'file-name';
        name.textContent = file.name;
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'file-checkbox';
        checkbox.onchange = () => {
          if (checkbox.checked) {
            selectedDriveFiles.add(file.id);
          } else {
            selectedDriveFiles.delete(file.id);
          }
          DOM.modalImport.disabled = selectedDriveFiles.size === 0;
        };
        item.appendChild(icon);
        item.appendChild(name);
        item.appendChild(checkbox);
        DOM.gdriveFileList.appendChild(item);
      });
    }

    async function importSelectedFromDrive() {
      showLoading('Importando imagens...');
      const selected = gdriveFiles.filter(f => selectedDriveFiles.has(f.id));
      const tabFiles = filesByTab.get(currentTab) || [];
      selected.forEach(f => {
        if (!tabFiles.find(x => x.id === f.id)) tabFiles.push(f);
      });
      filesByTab.set(currentTab, tabFiles);
      hideDriveModal();
      renderImages();
      hideLoading();
      showStatus(`Importadas ${selected.length} imagens do Google Drive para "${currentTab}".`);
    }

    // ====== EVENTOS ======
    DOM.openCloudFolderButton.onclick = () => {
      ensureGoogleAuth(async () => {
        showDriveModal();
        await listFilesInDriveFolder(GDRIVE_CONFIG.folderId);
        updateDriveFileList();
      });
    };
    DOM.modalClose.onclick = DOM.modalCancel.onclick = hideDriveModal;
    DOM.modalImport.onclick = importSelectedFromDrive;

    // Local file import
    DOM.openFileDialogButton.onclick = () => DOM.fileInput.click();
    DOM.fileInput.onchange = async (e) => {
      const files = Array.from(e.target.files);
      const tabFiles = filesByTab.get(currentTab) || [];
      let count = 0;
      for (const file of files) {
        if (!/^image\//.test(file.type)) continue;
        const reader = new FileReader();
        reader.onload = function(event) {
          tabFiles.push({
            id: `local-${Date.now()}-${Math.random()}`,
            name: file.name,
            url: event.target.result
          });
          filesByTab.set(currentTab, tabFiles);
          renderImages();
        };
        reader.readAsDataURL(file);
        count++;
      }
      showStatus(`${count} imagem(ns) importada(s) localmente.`);
    };

    // ====== INICIALIZAÇÃO ======
    window.onload = () => {
      createTabs();
      renderImages();
      window.gapiLoaded = gapiLoaded;
      window.gisLoaded = gisLoaded;
    };
  </script>
</body>
</html>
